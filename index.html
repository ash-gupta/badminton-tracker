<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badminton Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 450px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .sync-status {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 12px;
            opacity: 0.8;
        }

        .sync-online {
            color: #90EE90;
        }

        .sync-offline {
            color: #FFB6C1;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-btn {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .nav-btn.active {
            background: white;
            color: #4CAF50;
            border-bottom-color: #4CAF50;
        }

        .nav-btn:hover:not(.active) {
            background: #e9ecef;
        }

        .content {
            padding: 20px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #45a049;
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .team-setup {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .team {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .team h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #495057;
            font-size: 16px;
        }

        .team-a {
            border-color: #007bff;
        }

        .team-b {
            border-color: #dc3545;
        }

        .score-input {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .score-input h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        .score-help {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .leaderboard {
            background: white;
        }

        .player-card {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            transition: background 0.2s;
        }

        .player-card:hover {
            background: #f8f9fa;
        }

        .rank {
            width: 40px;
            height: 40px;
            background: #4CAF50;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .rank.gold {
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }

        .rank.silver {
            background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
        }

        .rank.bronze {
            background: linear-gradient(135deg, #CD7F32, #B8860B);
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .player-stats {
            font-size: 12px;
            color: #6c757d;
        }

        .rating {
            text-align: right;
            font-weight: 600;
            color: #4CAF50;
        }

        .games-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .game-card {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }

        .game-teams {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .game-team {
            font-weight: 500;
        }

        .game-scores {
            font-size: 14px;
            color: #6c757d;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state h3 {
            margin-bottom: 10px;
        }

        .friends-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .friend-name {
            font-weight: 500;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            width: auto;
            background: #dc3545;
        }

        .btn-small:hover {
            background: #c82333;
        }

        .data-actions {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .data-actions h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        @media (max-width: 480px) {
            .team-setup {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="sync-status" id="syncStatus">
                <span id="syncIndicator">üåê Online</span>
            </div>
            <h1>üè∏ Badminton Tracker</h1>
            <p>TrueSkill Friends Leaderboard</p>
        </div>

        <div class="nav">
            <button class="nav-btn active" onclick="showSection('leaderboard')">Leaderboard</button>
            <button class="nav-btn" onclick="showSection('game')">Add Game</button>
            <button class="nav-btn" onclick="showSection('friends')">Friends</button>
            <button class="nav-btn" onclick="showSection('history')">History</button>
        </div>

        <div class="content">
            <!-- Leaderboard Section -->
            <div id="leaderboard" class="section active">
                <div id="leaderboard-content"></div>
            </div>

            <!-- Add Game Section -->
            <div id="game" class="section">
                <div class="team-setup">
                    <div class="team team-a">
                        <h3>Team A</h3>
                        <div class="form-group">
                            <label>Player 1</label>
                            <select id="teamA1" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label>Player 2</label>
                            <select id="teamA2" class="form-control"></select>
                        </div>
                    </div>
                    <div class="team team-b">
                        <h3>Team B</h3>
                        <div class="form-group">
                            <label>Player 1</label>
                            <select id="teamB1" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label>Player 2</label>
                            <select id="teamB2" class="form-control"></select>
                        </div>
                    </div>
                </div>

                <div class="score-input">
                    <h3>Game Scores</h3>
                    <div class="form-group">
                        <input type="text" id="scores" class="form-control" placeholder="21-18 19-21 21-16">
                        <div class="score-help">Format: score-score separated by spaces (e.g., "21-18 19-21 21-16")</div>
                    </div>
                </div>

                <button class="btn" onclick="addGame()">Record Game</button>
            </div>

            <!-- Friends Section -->
            <div id="friends" class="section">
                <div class="form-group">
                    <label>Add New Friend</label>
                    <input type="text" id="newFriend" class="form-control" placeholder="Enter friend's name">
                </div>
                <button class="btn" onclick="addFriend()">Add Friend</button>

                <div style="margin-top: 30px;">
                    <h3>Current Friends</h3>
                    <div id="friends-list" class="friends-list"></div>
                </div>

                <div class="data-actions">
                    <h3>Data Management</h3>
                    <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
                    <button class="btn btn-secondary" onclick="importData()">Import Data</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
                    <button class="btn btn-secondary" onclick="resetData()">Reset All Data</button>
                </div>
            </div>

            <!-- History Section -->
            <div id="history" class="section">
                <div id="games-history"></div>
            </div>
        </div>
    </div>

    <script>
        // TrueSkill Parameters
        const PARAMS = {
            INIT_MU: 25.0,
            INIT_SIGMA: 25.0 / 3,
            BASE_K: 6.0,
            SIGMA_DECAY: 0.99,
            MIN_SIGMA: 2.0
        };

        // Bucket definitions
        const BUCKETS = {
            'Random [Newbie]': { mu: 20, sigma: 2 },
            'Random [Average]': { mu: 25, sigma: 2 },
            'Random [Good]': { mu: 30, sigma: 2 },
            'Random [Great]': { mu: 35, sigma: 2 }
        };

        // JSONBin Configuration
        const JSONBIN_CONFIG = {
            binId: '68c8fa8443b1c97be9448bee', // Replace with your actual Bin ID
            apiKey: '$2a$10$16lhtBclc17Ihw4xeliVJuFDkjfRd4hTgdlUM7go6vCcMRcUGZXEm', // Replace with your actual API Key
            baseUrl: 'https://api.jsonbin.io/v3'
        };

        // Data storage
        let gameData = {
            friends: {},
            matches: []
        };

        let isOnline = navigator.onLine;
        let saveQueue = [];

        // Load data from JSONBin with localStorage fallback
        async function loadData() {
            try {
                if (isOnline && JSONBIN_CONFIG.binId !== 'YOUR_BIN_ID_HERE') {
                    const response = await fetch(`${JSONBIN_CONFIG.baseUrl}/b/${JSONBIN_CONFIG.binId}/latest`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': JSONBIN_CONFIG.apiKey
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        gameData = result.record;
                        // Backup to localStorage
                        localStorage.setItem('badmintonTracker', JSON.stringify(gameData));
                        console.log('‚úÖ Data loaded from cloud');
                        return;
                    }
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Cloud load failed, using local data:', error.message);
            }
            
            // Fallback to localStorage
            const stored = localStorage.getItem('badmintonTracker');
            if (stored) {
                gameData = JSON.parse(stored);
                console.log('üì± Data loaded from device');
            }
        }

        // Save data to JSONBin with localStorage backup
        async function saveData() {
            // Always save locally first (instant)
            localStorage.setItem('badmintonTracker', JSON.stringify(gameData));
            
            // Try to save to cloud
            if (isOnline && JSONBIN_CONFIG.binId !== 'YOUR_BIN_ID_HERE') {
                try {
                    console.log('üîÑ Syncing to cloud...');
                    const response = await fetch(`${JSONBIN_CONFIG.baseUrl}/b/${JSONBIN_CONFIG.binId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': JSONBIN_CONFIG.apiKey
                        },
                        body: JSON.stringify(gameData)
                    });
                    
                    if (response.ok) {
                        console.log('‚òÅÔ∏è Data synced to cloud');
                        showSyncMessage('Synced to cloud ‚úÖ');
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Cloud save failed:', error.message);
                    showSyncMessage('Sync failed - saved locally ‚ö†Ô∏è');
                }
            } else if (JSONBIN_CONFIG.binId === 'YOUR_BIN_ID_HERE') {
                console.log('üì± JSONBin not configured - using local storage only');
                showSyncMessage('Local only - no cloud sync');
            }
        }

        // Monitor online status
        window.addEventListener('online', () => {
            isOnline = true;
            updateSyncStatus();
            console.log('üåê Back online');
            // Could sync queued changes here
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateSyncStatus();
            console.log('üì± Offline mode');
        });

        // Update sync status indicator
        function updateSyncStatus() {
            const indicator = document.getElementById('syncIndicator');
            const status = document.getElementById('syncStatus');
            
            if (!isOnline) {
                indicator.textContent = 'üì± Offline';
                status.className = 'sync-status sync-offline';
            } else if (JSONBIN_CONFIG.binId === 'YOUR_BIN_ID_HERE') {
                indicator.textContent = 'üì± Local Only';
                status.className = 'sync-status sync-offline';
            } else {
                indicator.textContent = '‚òÅÔ∏è Cloud Ready';
                status.className = 'sync-status sync-online';
            }
        }

        // Show temporary sync message
        function showSyncMessage(message) {
            const indicator = document.getElementById('syncIndicator');
            const originalText = indicator.textContent;
            
            indicator.textContent = message;
            setTimeout(() => {
                updateSyncStatus();
            }, 2000);
        }

        // Initialize app
        async function init() {
            await loadData();
            updateSyncStatus();
            updateAllSelects();
            updateLeaderboard();
            updateFriendsList();
            updateHistory();
        }

        // Navigation
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
        }

        // Add friend
        async function addFriend() {
            const name = document.getElementById('newFriend').value.trim();
            if (!name) {
                alert('Please enter a friend\'s name');
                return;
            }
            if (gameData.friends[name]) {
                alert('Friend already exists');
                return;
            }

            gameData.friends[name] = {
                mu: PARAMS.INIT_MU,
                sigma: PARAMS.INIT_SIGMA,
                gp: 0
            };

            document.getElementById('newFriend').value = '';
            await saveData();
            updateAllSelects();
            updateFriendsList();
            updateLeaderboard();
        }

        // Remove friend
        async function removeFriend(name) {
            if (confirm(`Are you sure you want to remove ${name}?`)) {
                delete gameData.friends[name];
                await saveData();
                updateAllSelects();
                updateFriendsList();
                updateLeaderboard();
            }
        }

        // Update all select dropdowns
        function updateAllSelects() {
            const selects = ['teamA1', 'teamA2', 'teamB1', 'teamB2'];
            const options = Object.keys(gameData.friends).concat(Object.keys(BUCKETS));
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select player...</option>';
                
                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    select.appendChild(optionElement);
                });
                
                select.value = currentValue;
            });
        }

        // TrueSkill calculations
        function expectedShare(dMu) {
            const x = dMu * (16 / 400.0);
            return 1.0 / (1.0 + Math.pow(10, -x));
        }

        function strengthDamp(dMu) {
            const x = dMu * (16 / 400.0);
            return 2.2 / (0.001 * Math.abs(x) + 2.2);
        }

        function getPlayerStats(player) {
            if (gameData.friends[player]) {
                return gameData.friends[player];
            } else if (BUCKETS[player]) {
                return BUCKETS[player];
            }
            return { mu: PARAMS.INIT_MU, sigma: PARAMS.INIT_SIGMA };
        }

        function isFriend(player) {
            return gameData.friends.hasOwnProperty(player);
        }

        // Parse scores
        function parseScores(scoresText) {
            const scoreRegex = /(\d+)-(\d+)/g;
            const scores = [];
            let match;
            
            while ((match = scoreRegex.exec(scoresText)) !== null) {
                scores.push([parseInt(match[1]), parseInt(match[2])]);
            }
            
            return scores;
        }

        // Add game
        async function addGame() {
            const teamA = [
                document.getElementById('teamA1').value,
                document.getElementById('teamA2').value
            ];
            const teamB = [
                document.getElementById('teamB1').value,
                document.getElementById('teamB2').value
            ];
            const scoresText = document.getElementById('scores').value.trim();

            // Validation
            if (teamA.includes('') || teamB.includes('')) {
                alert('Please select all players');
                return;
            }
            if (!scoresText) {
                alert('Please enter game scores');
                return;
            }

            const scores = parseScores(scoresText);
            if (scores.length === 0) {
                alert('Please enter valid scores (e.g., "21-18 19-21 21-16")');
                return;
            }

            // Calculate totals
            const ptsA = scores.reduce((sum, [a, b]) => sum + a, 0);
            const ptsB = scores.reduce((sum, [a, b]) => sum + b, 0);
            const total = ptsA + ptsB;

            if (total <= 0) {
                alert('Invalid scores');
                return;
            }

            // Update ratings
            updateMatch(teamA, teamB, scores);

            // Save match
            gameData.matches.push({
                timestamp: Date.now(),
                teamA: [...teamA],
                teamB: [...teamB],
                scores: [...scores],
                ptsA: ptsA,
                ptsB: ptsB
            });

            // Clear form
            document.getElementById('scores').value = '';
            document.querySelectorAll('#game select').forEach(s => s.value = '');

            await saveData();
            updateLeaderboard();
            updateHistory();
            
            alert('Game recorded successfully!');
        }

        function updateMatch(teamA, teamB, scores) {
            const ptsA = scores.reduce((sum, [a, b]) => sum + a, 0);
            const ptsB = scores.reduce((sum, [a, b]) => sum + b, 0);
            const total = ptsA + ptsB;

            if (total <= 0) return;

            const sumMuA = getPlayerStats(teamA[0]).mu + getPlayerStats(teamA[1]).mu;
            const sumMuB = getPlayerStats(teamB[0]).mu + getPlayerStats(teamB[1]).mu;
            const dMu = sumMuA - sumMuB;

            const Ep = expectedShare(dMu);
            const Sp = ptsA / total;

            const mov = Math.max(0.05, Math.min(1.0, Math.abs(Sp - 0.5) * 2.0));
            const scale = mov * strengthDamp(dMu);
            const deltaBase = (Sp - Ep) * scale;

            // Update Team A
            teamA.forEach(player => {
                if (isFriend(player)) {
                    const stats = gameData.friends[player];
                    const k = PARAMS.BASE_K * (stats.sigma / PARAMS.INIT_SIGMA);
                    stats.mu += k * deltaBase;
                    stats.sigma = Math.max(PARAMS.MIN_SIGMA, stats.sigma * PARAMS.SIGMA_DECAY);
                    stats.gp += 1;
                }
            });

            // Update Team B
            teamB.forEach(player => {
                if (isFriend(player)) {
                    const stats = gameData.friends[player];
                    const k = PARAMS.BASE_K * (stats.sigma / PARAMS.INIT_SIGMA);
                    stats.mu -= k * deltaBase;
                    stats.sigma = Math.max(PARAMS.MIN_SIGMA, stats.sigma * PARAMS.SIGMA_DECAY);
                    stats.gp += 1;
                }
            });
        }

        // Update leaderboard
        function updateLeaderboard() {
            const container = document.getElementById('leaderboard-content');
            const friends = Object.entries(gameData.friends)
                .map(([name, stats]) => ({
                    name,
                    ...stats,
                    score: stats.mu - 3 * stats.sigma
                }))
                .sort((a, b) => {
                    if (Math.abs(a.score - b.score) < 0.01) {
                        return b.mu - a.mu;
                    }
                    return b.score - a.score;
                });

            if (friends.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Friends Yet</h3>
                        <p>Add some friends to start tracking games!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = friends.map((friend, index) => {
                let rankClass = '';
                if (index === 0) rankClass = 'gold';
                else if (index === 1) rankClass = 'silver';
                else if (index === 2) rankClass = 'bronze';

                return `
                    <div class="player-card">
                        <div class="rank ${rankClass}">${index + 1}</div>
                        <div class="player-info">
                            <div class="player-name">${friend.name}</div>
                            <div class="player-stats">
                                Œº: ${friend.mu.toFixed(1)} | œÉ: ${friend.sigma.toFixed(1)} | Games: ${friend.gp}
                            </div>
                        </div>
                        <div class="rating">${friend.score.toFixed(1)}</div>
                    </div>
                `;
            }).join('');
        }

        // Update friends list
        function updateFriendsList() {
            const container = document.getElementById('friends-list');
            const friends = Object.keys(gameData.friends);

            if (friends.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Friends Added</h3>
                        <p>Add your first friend above!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = friends.map(name => `
                <div class="friend-item">
                    <div class="friend-name">${name}</div>
                    <button class="btn btn-small" onclick="removeFriend('${name}')">Remove</button>
                </div>
            `).join('');
        }

        // Update history
        function updateHistory() {
            const container = document.getElementById('games-history');
            const matches = [...gameData.matches].reverse();

            if (matches.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Games Recorded</h3>
                        <p>Record your first game to see history!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="games-list">
                    ${matches.map(match => `
                        <div class="game-card">
                            <div class="game-teams">
                                <div class="game-team">${match.teamA.join(' & ')}</div>
                                <div class="game-team">${match.teamB.join(' & ')}</div>
                            </div>
                            <div class="game-scores">
                                ${match.scores.map(([a, b]) => `${a}-${b}`).join(', ')} 
                                (Total: ${match.ptsA}-${match.ptsB})
                            </div>
                            <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                                ${new Date(match.timestamp).toLocaleString()}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Data management
        function exportData() {
            const dataStr = JSON.stringify(gameData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'badminton_data.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (confirm('This will replace all current data. Are you sure?')) {
                        gameData = importedData;
                        saveData();
                        init();
                        alert('Data imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing data. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }

        function resetData() {
            if (confirm('Are you sure you want to reset all data? This cannot be undone.')) {
                gameData = { friends: {}, matches: [] };
                saveData();
                init();
                alert('All data has been reset.');
            }
        }

        // Initialize app when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
